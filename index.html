<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DnD Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .bg-opacity-80 {
        background-color: rgba(250, 255, 240, 0.4);
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen pt-4 flex flex-col justify-between space-y-6 items-center"
    style="
      background-image: url('images/dnd_bg.jpg');
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
    "
  >
    <div class="flex w-full max-w-7xl gap-6 items-start">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="w-100 bg-white/80 rounded-lg shadow p-4 space-y-6 transition-all duration-300"
      >
        <!-- Players Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Players</h2>
          <div class="flex items-center gap-2 justify-start">
            <div class="flex items-center bg-white border rounded shadow-sm">
              <button
                type="button"
                onclick="adjustCount('playerCount', -1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-r"
              >
                −
              </button>
              <span
                id="playerCountDisplay"
                class="text-lg font-medium min-w-[2rem] text-center"
                >2</span
              >
              <button
                type="button"
                onclick="adjustCount('playerCount', 1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-l"
              >
                +
              </button>
            </div>
            <button
              onclick="generatePlayers()"
              class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
            >
              Generate
            </button>
            <button
              id="duplicateToggle"
              class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
              onclick="toggleDuplicateMode()"
            >
              Duplicate Mode: Off
            </button>
          </div>
          <input type="hidden" id="playerCount" value="2" />
          <div
            id="playerButtons"
            class="mt-2 flex flex-wrap justify-start gap-2"
          ></div>
        </div>

        <!-- Enemies Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Enemies</h2>
          <div class="flex items-center gap-2 justify-start">
            <div class="flex items-center bg-white border rounded shadow-sm">
              <button
                type="button"
                onclick="adjustCount('enemyCount', -1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-r"
              >
                −
              </button>
              <span
                id="enemyCountDisplay"
                class="text-lg font-medium min-w-[2rem] text-center"
                >2</span
              >
              <button
                type="button"
                onclick="adjustCount('enemyCount', 1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-l"
              >
                +
              </button>
            </div>
            <button
              onclick="generateEnemies()"
              class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition"
            >
              Generate
            </button>
          </div>
          <input type="hidden" id="enemyCount" value="2" />
          <div
            id="enemyButtons"
            class="mt-2 flex flex-wrap justify-start gap-2"
          ></div>
        </div>

        <!-- Current Selection Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Current Selection</h2>
          <div
            id="selectedInfo"
            class="font-semibold text-lg flex justify-center items-center h-12 w-12 border rounded bg-white/80"
          ></div>
        </div>
        <!-- Solid Objects Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Solid Objects</h2>
          <div class="flex items-center gap-2">
            <div id="solidObjectPalette" class="flex gap-2"></div>
            <div class="relative inline-block w-10 h-10">
              <input
                type="color"
                id="colorPicker"
                value="#666666"
                class="w-10 h-10 border rounded cursor-pointer appearance-none"
                title="Pick a custom color"
              />
              <span
                class="absolute inset-0 flex items-center justify-center text-white font-bold pointer-events-none"
              >
                C
              </span>
            </div>
          </div>
        </div>
        <!-- Passable Objects Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Passable Objects</h2>
          <div class="flex items-center gap-2">
            <span>TBA</span>
            <div id="solidObjectPalette" class="flex gap-2"></div>
          </div>
        </div>
        <!-- Grid Settings Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Grid Settings</h2>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-semibold">Grid Size:</span>

            <!-- Rows Control -->
            <div class="flex items-center bg-white border rounded shadow-sm">
              <button
                type="button"
                onclick="adjustCount('gridRows', -1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-r"
              >
                −
              </button>
              <span
                id="gridRowsDisplay"
                class="px-4 text-lg font-medium min-w-[2rem] text-center"
                >20</span
              >
              <button
                type="button"
                onclick="adjustCount('gridRows', 1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-l"
              >
                +
              </button>
            </div>

            <!-- Columns Control -->
            <div class="flex items-center bg-white border rounded shadow-sm">
              <button
                type="button"
                onclick="adjustCount('gridCols', -1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-r"
              >
                −
              </button>
              <span
                id="gridColsDisplay"
                class="px-4 text-lg font-medium min-w-[2rem] text-center"
                >20</span
              >
              <button
                type="button"
                onclick="adjustCount('gridCols', 1)"
                class="px-3 py-1 text-lg text-gray-700 hover:bg-gray-100 border-l"
              >
                +
              </button>
            </div>

            <button
              onclick="generateGrid()"
              class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition"
            >
              Regenerate Grid
            </button>
          </div>

          <input type="hidden" id="gridRows" value="20" />
          <input type="hidden" id="gridCols" value="20" />

          <button
            onclick="clearGrid()"
            class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-900 transition mt-4"
          >
            Clear Grid
          </button>
        </div>
        <!-- Save/Load Section -->
        <div class="bg-yellow-500/30 p-4">
          <h2 class="text-lg font-bold mb-2">Save/Load</h2>
          <div class="flex items-center gap-2">
            <button
              onclick="saveBoardState()"
              class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition mt-2"
            >
              Save
            </button>

            <input type="file" id="importJson" class="hidden" accept=".json" />

            <label
              for="importJson"
              class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded cursor-pointer transition mt-2 inline-flex items-center justify-center"
              style="height: 2.5rem"
            >
              Load
            </label>

            <div id="solidObjectPalette" class="flex gap-2"></div>
          </div>
        </div>
      </div>

      <!-- Main Grid Column -->
      <div class="flex flex-col items-center space-y-4 shadow-md">
        <div
          id="grid"
          class="grid grid-cols-20 w-max mx-auto bg-gray-200 p-4 rounded-lg shadow-md"
        ></div>
      </div>
    </div>
    <footer class="w-full text-center py-4 bg-white/80 mt-6 rounded shadow">
      <p class="text-sm text-gray-700">&copy; DS 2025</p>
    </footer>
    <script>
      const playerCountInput = document.getElementById("playerCount");
      const enemyCountInput = document.getElementById("enemyCount");
      const playerButtons = document.getElementById("playerButtons");
      const enemyButtons = document.getElementById("enemyButtons");
      const grid = document.getElementById("grid");
      const selectedInfo = document.getElementById("selectedInfo");
      const solidObjectPalette = document.getElementById("solidObjectPalette");
      const solidObjectColors = [
        "bg-gray-500",
        "bg-green-600",
        "bg-yellow-700",
        "bg-purple-700",
        "bg-orange-700",
      ];
      let selectedSolidObjectColor = null;
      let selectedToken = null;
      let playerTokens = [];
      let enemyTokens = [];
      let selectedSquare = null;
      let duplicateMode = false;

      function toggleDuplicateMode() {
        duplicateMode = !duplicateMode;
        const btn = document.getElementById("duplicateToggle");
        btn.textContent = `Duplicate Mode: ${duplicateMode ? "On" : "Off"}`;
        btn.classList.toggle("bg-yellow-500", duplicateMode);
        btn.classList.toggle("bg-blue-600", !duplicateMode);
      }

      function createTokenButton(label, team, index, existingNames = {}) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-center gap-2 mb-2";

        const token = document.createElement("div");
        token.className = `w-10 h-10 flex items-center justify-center text-white font-bold cursor-pointer rounded-sm ${
          team === "player" ? "bg-blue-600" : "bg-red-600"
        }`;
        token.textContent = label;

        token.addEventListener("click", () => {
          selectedToken = token.cloneNode(true);
          selectedSolidObjectColor = null;

          document.querySelectorAll(".selected-token").forEach((el) => {
            el.classList.remove(
              "ring",
              "ring-2",
              "ring-yellow-400",
              "selected-token"
            );
          });

          document.querySelectorAll("#solidObjectPalette div").forEach((el) => {
            el.classList.remove("ring", "ring-2", "ring-yellow-400");
          });

          token.classList.add(
            "ring",
            "ring-2",
            "ring-yellow-400",
            "selected-token"
          );

          selectedInfo.innerHTML = "";
          selectedInfo.appendChild(selectedToken.cloneNode(true));
          selectedSquare = null;
        });

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Name";
        input.className = "px-2 py-1 border rounded text-sm";
        input.dataset.token = label;
        input.value = existingNames[label] || "";

        wrapper.appendChild(token);
        wrapper.appendChild(input);
        return { container: wrapper, token };
      }
      function getAllTokenNames() {
        const names = {};
        document.querySelectorAll("input[data-token]").forEach((input) => {
          names[input.dataset.token] = input.value;
        });
        return names;
      }

      function generateSolidObjectPalette() {
        solidObjectPalette.innerHTML = "";

        solidObjectColors.forEach((colorClass, index) => {
          const solidObject = document.createElement("div");
          solidObject.className = `w-10 h-10 ${colorClass} cursor-pointer rounded shadow border-2 border-transparent`;

          solidObject.addEventListener("click", () => {
            document
              .querySelectorAll("#solidObjectPalette div")
              .forEach((el) => {
                el.classList.remove("ring", "ring-2", "ring-yellow-400");
              });

            solidObject.classList.add("ring", "ring-2", "ring-yellow-400");
            selectedSolidObjectColor = colorClass;
            selectedToken = null;

            selectedInfo.innerHTML = "";
            selectedInfo.appendChild(solidObject.cloneNode(true));
          });

          solidObjectPalette.appendChild(solidObject);
        });

        const colorPicker = document.getElementById("colorPicker");
        colorPicker.addEventListener("input", () => {
          handleCustomColorSelection();
        });

        colorPicker.addEventListener("click", () => {
          handleCustomColorSelection();
        });

        function handleCustomColorSelection() {
          selectedSolidObjectColor = colorPicker.value;
          selectedToken = null;

          document.querySelectorAll("#solidObjectPalette div").forEach((el) => {
            el.classList.remove("ring", "ring-2", "ring-yellow-400");
          });

          selectedInfo.innerHTML = "";
          const customDiv = document.createElement("div");
          customDiv.style.backgroundColor = selectedSolidObjectColor;
          customDiv.className = "w-10 h-10 rounded border shadow";
          selectedInfo.appendChild(customDiv);
        }
      }

      function generatePlayers() {
        const count = parseInt(playerCountInput.value, 10);
        if (isNaN(count) || count < 1) {
          alert("Please enter a valid number of players.");
          return;
        }

        const existingNames = getAllTokenNames();
        playerButtons.innerHTML = "";
        playerTokens = [];

        for (let i = 0; i < count; i++) {
          const label = `P${i + 1}`;
          const { container, token } = createTokenButton(
            label,
            "player",
            i,
            existingNames
          );
          playerButtons.appendChild(container);
          playerTokens.push(token);
        }

        const firstBtn = playerButtons.querySelector("div div");
        if (firstBtn) firstBtn.click();
      }

      function adjustCount(id, delta) {
        const input = document.getElementById(id);
        const display = document.getElementById(id + "Display");
        let value = parseInt(input.value) + delta;
        if (value < 1) value = 1;
        input.value = value;
        display.textContent = value;
      }

      function generateEnemies() {
        const count = parseInt(enemyCountInput.value, 10);
        if (isNaN(count) || count < 1) {
          alert("Please enter a valid number of enemies.");
          return;
        }

        const existingNames = getAllTokenNames();
        enemyButtons.innerHTML = "";
        enemyTokens = [];

        for (let i = 0; i < count; i++) {
          const label = `E${i + 1}`;
          const { container, token } = createTokenButton(
            label,
            "enemy",
            i,
            existingNames
          );
          enemyButtons.appendChild(container);
          enemyTokens.push(token);
        }
      }

      function setupGrid(rows = 20, cols = 20) {
        grid.style.gridTemplateColumns = `repeat(${cols}, 2.5rem)`;
        grid.innerHTML = "";

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const square = document.createElement("div");
            square.className =
              "w-10 h-10 bg-white border border-gray-600 flex items-center justify-center hover:bg-gray-300 transition-colors duration-50 cursor-pointer select-none";

            square.setAttribute("data-coord", `${row}-${col}`);

            square.addEventListener("click", (event) => {
              const isShiftHeld = event.shiftKey;
              const allowDuplicate = isShiftHeld || duplicateMode;

              if (selectedSolidObjectColor) {
                if (square.dataset.type === "solidObject") return;
                square.innerHTML = "";
                const obj = document.createElement("div");
                obj.className = "w-10 h-10 rounded";

                if (selectedSolidObjectColor.startsWith("#")) {
                  obj.style.backgroundColor = selectedSolidObjectColor;
                } else {
                  obj.classList.add(selectedSolidObjectColor);
                }

                square.appendChild(obj);
                square.dataset.type = "solidObject";
              } else if (selectedToken) {
                if (square.dataset.type === "solidObject") return;

                if (!allowDuplicate) {
                  grid.querySelectorAll("div").forEach((sq) => {
                    if (
                      sq.firstElementChild &&
                      sq.firstElementChild.textContent ===
                        selectedToken.textContent
                    ) {
                      sq.innerHTML = "";
                      delete sq.dataset.type;
                    }
                  });
                }

                square.innerHTML = "";
                square.appendChild(selectedToken.cloneNode(true));
                square.dataset.type = "token";
                updateSelectedInfo(square);
              }
            });

            square.addEventListener("mouseenter", (event) => {
              if (event.buttons === 1) {
                applySelectionToSquare(square, event);
              } else if (event.buttons === 2) {
                eraseSquare(square);
              }
            });

            square.addEventListener("click", (event) => {
              applySelectionToSquare(square, event);
            });

            square.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              eraseSquare(square);
            });

            grid.appendChild(square);
          }
        }
      }

      function eraseSquare(square) {
        square.innerHTML = "";
        if (square.firstElementChild) {
          square.firstElementChild.removeAttribute("style");
        }
        delete square.dataset.type;

        if (selectedSquare === square) {
          selectedInfo.innerHTML = "";
          selectedSquare = null;
        }
      }

      function applySelectionToSquare(square, event) {
        const isShiftHeld = event.shiftKey;
        const allowDuplicate = isShiftHeld || duplicateMode;

        if (selectedSolidObjectColor) {
          if (square.dataset.type === "solidObject") return;
          square.innerHTML = "";
          const obj = document.createElement("div");
          obj.className = "w-10 h-10 rounded";

          if (selectedSolidObjectColor.startsWith("#")) {
            obj.style.backgroundColor = selectedSolidObjectColor;
          } else {
            obj.classList.add(selectedSolidObjectColor);
          }

          square.appendChild(obj);
          square.dataset.type = "solidObject";
        } else if (selectedToken) {
          if (square.dataset.type === "solidObject") return;

          if (!allowDuplicate) {
            grid.querySelectorAll("div").forEach((sq) => {
              if (
                sq.firstElementChild &&
                sq.firstElementChild.textContent === selectedToken.textContent
              ) {
                sq.innerHTML = "";
                delete sq.dataset.type;
              }
            });
          }

          square.innerHTML = "";
          square.appendChild(selectedToken.cloneNode(true));
          square.dataset.type = "token";
          updateSelectedInfo(square);
        }
      }

      function updateSelectedInfo(square) {
        selectedSquare = square;
        selectedInfo.innerHTML = "";
        const clone = square.firstElementChild?.cloneNode(true);
        if (clone) {
          selectedInfo.appendChild(clone);
        } else {
          selectedInfo.textContent = "";
        }
      }

      function generateGrid() {
        const rows = parseInt(document.getElementById("gridRows").value, 10);
        const cols = parseInt(document.getElementById("gridCols").value, 10);

        if (isNaN(rows) || rows < 1 || isNaN(cols) || cols < 1) {
          alert("Please enter valid grid dimensions.");
          return;
        }

        setupGrid(rows, cols);
      }

      function clearGrid() {
        grid.querySelectorAll("div").forEach((square) => {
          square.innerHTML = "";
          delete square.dataset.type;
        });
        selectedInfo.innerHTML = "";
        selectedSquare = null;
      }

      function syncGridControls() {
        const rows = document.getElementById("gridRows").value;
        const cols = document.getElementById("gridCols").value;

        document.getElementById("gridRowsDisplay").textContent = rows;
        document.getElementById("gridColsDisplay").textContent = cols;
      }

      function syncPlayerEnemyDisplays() {
        const playerCount = document.getElementById("playerCount").value;
        const enemyCount = document.getElementById("enemyCount").value;

        document.getElementById("playerCountDisplay").textContent = playerCount;
        document.getElementById("enemyCountDisplay").textContent = enemyCount;
      }

      const initialRows = parseInt(
        document.getElementById("gridRows").value,
        10
      );
      const initialCols = parseInt(
        document.getElementById("gridCols").value,
        10
      );
      setupGrid(initialRows, initialCols);
      generatePlayers();
      generateEnemies();
      generateSolidObjectPalette();
      syncGridControls();
      syncPlayerEnemyDisplays();

      document
        .getElementById("importJson")
        .addEventListener("change", loadBoardStateFromFile);
      function saveBoardState() {
        const rows = parseInt(document.getElementById("gridRows").value, 10);
        const cols = parseInt(document.getElementById("gridCols").value, 10);
        const tiles = grid.querySelectorAll("#grid > div");

        const gridData = Array.from(tiles).map((square) => ({
          coord: square.getAttribute("data-coord"),
          innerHTML: square.innerHTML,
          type: square.dataset.type || null,
        }));

        const boardState = {
          rows,
          cols,
          playerCount: parseInt(playerCountInput.value),
          enemyCount: parseInt(enemyCountInput.value),
          duplicateMode,
          gridData,
        };

        const dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(boardState, null, 2));
        const dlAnchor = document.createElement("a");
        dlAnchor.setAttribute("href", dataStr);
        dlAnchor.setAttribute("download", "dnd_board_state.json");
        document.body.appendChild(dlAnchor);
        dlAnchor.click();
        document.body.removeChild(dlAnchor);
      }

      function loadBoardStateFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);
            loadBoardState(data);
          } catch (err) {
            alert("Failed to parse JSON.");
          }
        };
        reader.readAsText(file);
      }

      function loadBoardState(data) {
        document.getElementById("gridRows").value = data.rows;
        document.getElementById("gridRowsDisplay").textContent = data.rows;
        document.getElementById("gridCols").value = data.cols;
        document.getElementById("gridColsDisplay").textContent = data.cols;
        document.getElementById("playerCount").value = data.playerCount;
        document.getElementById("playerCountDisplay").textContent =
          data.playerCount;
        document.getElementById("enemyCount").value = data.enemyCount;
        document.getElementById("enemyCountDisplay").textContent =
          data.enemyCount;
        syncPlayerEnemyDisplays();
        duplicateMode = data.duplicateMode;

        toggleDuplicateMode();
        generatePlayers();
        generateEnemies();
        setupGrid(data.rows, data.cols);

        setTimeout(() => {
          const squares = grid.querySelectorAll("#grid > div");
          const squareMap = {};
          squares.forEach((sq) => {
            squareMap[sq.getAttribute("data-coord")] = sq;
          });

          data.gridData.forEach((tile) => {
            const targetSquare = squareMap[tile.coord];
            if (targetSquare) {
              targetSquare.innerHTML = tile.innerHTML;
              if (tile.type) {
                targetSquare.dataset.type = tile.type;
              } else {
                delete targetSquare.dataset.type;
              }
            }
          });
        }, 50);
      }

      let isMouseDown = false;

      document.addEventListener("mousedown", () => {
        isMouseDown = true;
      });

      document.addEventListener("mouseup", () => {
        isMouseDown = false;
      });
    </script>
  </body>
</html>
